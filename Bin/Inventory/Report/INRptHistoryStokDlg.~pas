unit INRptHistoryStokDlg;

interface

uses
  Windows, Messages, SysUtils, Variants, Classes, Graphics, Controls, Forms,
  Dialogs, RptDlg, dxCntner, dxEditor, dxExEdtr, dxEdLib, StdCtrls, DB,
  ADODB, Buttons, ExtCtrls, dxTL, dxDBCtrl, dxDBGrid, dxCore, dxButton;

type
  TfmINRptHistoryBarangDlg = class(TfmRptDlg)
    quMain: TADOQuery;
    dsMain: TDataSource;
    GroupBox1: TGroupBox;
    Label2: TLabel;
    dt1: TdxDateEdit;
    dt2: TdxDateEdit;
    rbAll: TRadioButton;
    rbSelect: TRadioButton;
    dbgWare: TdxDBGrid;
    dbgListWareHouseID: TdxDBGridColumn;
    dbgListwareHouseName: TdxDBGridColumn;
    Panel1: TPanel;
    rbselect2: TRadioButton;
    rbAll2: TRadioButton;
    dbgList: TdxDBGrid;
    dbgListItemId: TdxDBGridMaskColumn;
    dbgListItemName: TdxDBGridMaskColumn;
    bbCancel: TdxButton;
    procedure rbSelectClick(Sender: TObject);
    procedure bbPreviewClick(Sender: TObject);
    procedure FormShow(Sender: TObject);
    procedure rbselect2Click(Sender: TObject);
    procedure bbCancelClick(Sender: TObject);
  private
    { Private declarations }
  public
    { Public declarations }
  end;

var
  fmINRptHistoryBarangDlg: TfmINRptHistoryBarangDlg;

implementation

uses StdLv0, INQRRptHistoryStok, UnitGeneral, RptLv0, Search, UnitDate;

{$R *.dfm}

procedure TfmINRptHistoryBarangDlg.rbSelectClick(Sender: TObject);
begin
  inherited;
  if Sender=rbAll then
  begin
     dbgWare.OptionsBehavior := dbgWare.OptionsBehavior - [edgoMultiSelect];
  end else
  if Sender=rbSelect then
  begin
     dbgware.OptionsBehavior := dbgWare.OptionsBehavior + [edgoMultiSelect];
     if dbgware.FocusedNode <> nil then
       dbgware.FocusedNode.Selected := TRUE;
  end;
end;

procedure TfmINRptHistoryBarangDlg.bbPreviewClick(Sender: TObject);
begin
  inherited;
  with TfmINQRRptHistoryStok.Create(Self) do
     try
       qrlTitle.Caption := laTitle.Caption;
       qrlPeriode.Caption := 'Periode : '+FormatDateTime('dd/MM/yyyy',dt1.date)+' s/d '+FormatDateTime('dd/MM/yyyy',dt2.date);
       tgldari:=dt1.date;
       tglsmp:=dt2.Date;

       with qu001,sql do
       begin
          Close;Clear;
          add('select distinct A.WareHouseId,(A.WareHouseID+''-''+B.WareHouseName) as Gudang '
             +' FROM Allitem A INNER JOIN '
             +' INMsWareHouse B ON A.WareHouseID=B.WareHouseID');
          if rbSelect.Checked then
           Add('  and A.WareHouseID IN '+SelGrid(quMain,dbgWare,'WareHouseID'));
          if rbSelect2.Checked then
           Add('  and A.ItemID IN '+SelGrid(quact,dbgList,'ItemID'));
           add('  order by A.WareHouseID ');
           Open;
          if IsEmpty then
          begin
             MsgInfo('No Data !');
             Abort;
          end;
       end;

       with qu002,sql do
       begin
          Close;Clear;
          add(' select distinct A.ItemId,(A.ItemID+''-''+B.ItemName) as Barang,B.ItemName,B.UOMId,C.ProductDesc, '
             +' WareHouseID FROM Allitem A INNER JOIN '
             +' INMsItem B ON A.ItemID=B.ItemID'
             +' INNER JOIN INMsProduct C ON B.ProductId=C.ProductId'
             +' WHERE WareHouseID=:WareHouseId'
             +' And CONVERT(varchar(8),A.TransDate,112) <= '''+FormatDateTime('yyyyMMdd',dt2.Date)+''' ');//BETWEEN '''+FormatDateTime('yyyyMMdd',dt1.Date)+''' AND '''+FormatDateTime('yyyyMMdd',dt2.Date)+'''');
          if rbSelect2.Checked then
           Add('  and A.ItemID IN '+SelGrid(quact,dbgList,'ItemID'));
           add('  order by A.ItemID ');
           Open;
          if IsEmpty then
          begin
             MsgInfo('No Data !');
             Abort;
          end;
       end;

  with qu003,sql do
  begin
     Close;Clear;
     add(' SELECT Convert(varchar(10),A.TransDate,103)as Tanggal,A.TransDate, '
        +' case when FgTrans < 50 Then ''1'' else ''2'' end as Kode,'
        +'         case Fgtrans when 0  then  ''Tr Stok Awal Posistif & VoucherNo ''+ A.VoucherNo '
        +'                              when 2  then  ''Tr Transfer Barang (+) Nota ''+ A.VoucherNo +'' ''+A.TempField2 '
        +'                              when 3  then  ''Tr Stok Opname Bertambah Nota ''+ A.VoucherNo +'' ''+A.TempField2'
        +'                              when 5  then  ''Tr Pembelian Invoice ''+ A.VoucherNo +'' ''+A.TempField2'
        +'                              when 6  then  ''Tr Pengganti Retur Pembelian Nota ''+ A.VoucherNo +'' ''+A.TempField2'
        +'                              when 7  then  ''Tr Penerimaan Barang Nota ''+ A.VoucherNo +'' ''+A.TempField2 '
        +'                              when 8 then   ''Tr Retur Penjualan Invoice ''+ A.VoucherNo +'' ''+A.TempField2'
        +'                              when 9 then   ''Tr Tarik Barang Konsinyasi Nota ''+ A.VoucherNo +'' ''+A.TempField2'
        +'                              when 10 then  ''Tr Terima Service Nota ''+ A.VoucherNo +'' ''+A.TempField2 '
        +'                              when 52 then  ''Tr Transfer Barang (-) Nota ''+ A.VoucherNo  +'' ''+A.TempField2 '
        +'                              when 53 then  ''Tr Stok Opname Berkurang Nota ''+ A.VoucherNo +'' ''+A.TempField2'
        +'                              when 55 then  ''Tr Penjualan Nota ''+ A.VoucherNo +'' ''+A.TempField2'
        +'                              when 56 then  ''Tr Retur Pembelian Nota ''+ A.VoucherNo +'' ''+A.TempField2'
        +'                              when 57 then  ''Tr Retur Konsinyasi Pembelian ''+ A.VoucherNo +'' ''+A.TempField2 '
        +'                              when 58 then  ''Tr Pengganti Retur Penjualan Nota ''+ A.VoucherNo +'' ''+A.TempField2'
        +'                              when 59 then  ''Tr Konsinyasi Transfer Barang Nota ''+ A.VoucherNo +'' ''+A.TempField2 '
        +'                              when 61 then  ''Tr Penggunaan SparePart Nota ''+ A.VoucherNo +'' ''+A.TempField2 '
        +'                              when 60 then  ''Tr Ambil Service Nota ''+ A.VoucherNo +'' ''+A.TempField2 end as Flag '
        +' ,A.QTy,A.FgTrans,ISNULL(A.Price,0) as Nilai FROM Allitem A where A.ItemId='''+qu002.FieldByName('ItemId').AsString+''''
        +' AND A.WareHouseId='''+qu001.fieldbyname('WareHouseId').AsString+''''
        +' AND CONVERT(varchar(8),A.TransDate,112) BETWEEN '''+FormatDateTime('yyyyMMdd',tgldari)+''' AND '''+FormatDateTime('yyyyMMdd',tglsmp)+''''
        +' ORDER by Convert(varchar(10),A.TransDate,112),kode,NumAll');
    ShowMessage(SQL.Text);
    Open;
  End;
       qu003.Open;

       if Sender=bbPreview then
          MyReport.PreviewModal
       else
          MyReport.Print;


     finally
        free;
     end;
end;

procedure TfmINRptHistoryBarangDlg.FormShow(Sender: TObject);
begin
  inherited;
  quAct.Open;
  qumain.Open;
  dt1.Date:=EncodeDate(GetYear(Date),GetMonth(Date),1);
  dt2.Date:=date;
end;

procedure TfmINRptHistoryBarangDlg.rbselect2Click(Sender: TObject);
begin
  inherited;
  if Sender=rbAll2 then
  begin
     dbgList.OptionsBehavior := dbgList.OptionsBehavior - [edgoMultiSelect];
  end else
  if Sender=rbSelect2 then
  begin
     dbgList.OptionsBehavior := dbgList.OptionsBehavior + [edgoMultiSelect];
     if dbgList.FocusedNode <> nil then
       dbgList.FocusedNode.Selected := TRUE;
  end;
end;

procedure TfmINRptHistoryBarangDlg.bbCancelClick(Sender: TObject);
begin
  inherited;
   with TfmSearch.Create(Self) do
    try
       Title := 'Barang';
       SQLString := ' SELECT ItemName as Nama_Barang ,ItemId as Kode_Barang'
                   +' FROM INMsItem A '
                   +' ORDER BY ItemID';

       if ShowModal = MrOK then
       begin
         Self.quAct.Locate('ItemID',Res[1],[]);
       end;
    finally
       free;
    end;
end;

end.
